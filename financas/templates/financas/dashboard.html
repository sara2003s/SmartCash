{% extends "financas/base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Dashboard - SmartCash{% endblock %}

{% block content %}
<div class="container mx-auto">

    <h1 class="text-3xl font-bold mb-2">Ol√°, {{ user.first_name|default:user.username }}! üëã</h1>
    <p class="text-gray-500 mb-6">Aqui est√° um resumo da sua situa√ß√£o financeira atual.</p>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white shadow rounded p-4">
            <h2 class="text-gray-600">Saldo Atual</h2>
            <p class="text-2xl font-bold text-green-600">R$ 0,00 {{ saldo|floatformat:2 }}</p>
            <p class="text-sm text-gray-500">
                {% if saldo > 0 %}
                ‚Üó Voc√™ j√° tem R$ {{ saldo|floatformat:2 }} guardados üöÄ
                {% else %}
                Seu saldo est√° zerado. Adicione uma receita para come√ßar!
                {% endif %}
            </p>
        </div>
        <div class="bg-white shadow rounded p-4">
            <h2 class="text-gray-600">Receitas</h2>
            <p class="text-2xl font-bold text-blue-600">R$ 0,00 {{ entradas|floatformat:2 }}</p>
            <p class="text-sm text-gray-500">
                {% if entradas > 0 %}
                Recebeu um total de R$ {{ entradas|floatformat:2 }} em receitas.
                {% else %}
                Nenhuma receita registrada ainda.
                {% endif %}
            </p>
        </div>
        
        <div class="bg-white shadow rounded p-4">
            <h2 class="text-gray-600">Gastos</h2>
            <p class="text-2xl font-bold text-red-600">- R$ 0,00 {{ saidas|floatformat:2 }}</p>
            <p class="text-sm text-gray-500">
                {% if saidas > 0 %}
                Gastou R$ {{ saidas|floatformat:2 }} em suas despesas.
                {% else %}
                Nenhuma despesa registrada ainda.
                {% endif %}
            </p>
        </div>

        <div class="bg-white shadow rounded p-4">
            <h2 class="text-gray-600">Meta de Economia</h2>
            <p class="text-2xl font-bold text-black-600">R$ {{ meta }}</p>
            <div class="w-full bg-gray-200 rounded h-3 mt-2">
            </div>
            {% if meta > 0 %}
            Progresso: R$ {{ meta|floatformat:2 }} / R$ {{ meta_total|floatformat:2 }}
            {% else %}
            <p class="text-sm text-gray-600">
                Nenhuma meta definida ainda. Crie sua primeira meta
            </p>
            {% endif %}
        </div>
        </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div class="bg-white shadow rounded p-6">
            <h2 class="text-xl font-semibold mb-1">Evolu√ß√£o Financeira</h2>
            <p class="text-gray-500 mb-4">Receitas, gastos e economia nos √∫ltimos 6 meses</p>
            <canvas id="financeChart" class="h-64"></canvas>
        </div>

        <div class="col-span-1 bg-white p-6 rounded-lg shadow flex flex-col justify-between h-full">
            <h2 class="text-xl font-semibold mb-4">Recomenda√ß√µes Inteligentes</h2>
            <ul class="space-y-3 flex-1">
                <li class="p-3 bg-white-50 border border-red-200 rounded">
                    ‚ö†Ô∏è <strong>Aten√ß√£o:</strong>
                    <h2>Gastos com alimenta√ß√£o representam 37% das despesas.</h2>
                </li>
                <li class="p-3 bg-white-50 border border-green-200 rounded">
                    üí° <strong>Potencial de investimento identificado:</strong>
                    <h2>Com R$ 5241 dispon√≠veis, voc√™ pode investir em CDB (rendimento de ~110% CDI) e obter R$ 419
                        anuais.</h2>
                </li>
                <li class="p-3 bg-white-50 border border-yellow-200 rounded">
                    üìà <strong>Construa sua reserva de emerg√™ncia:</strong>
                    <h2>Voc√™ pode investir em CDB (~110% CDI) e ganhar R$ 419/ano.</h2>
                </li>
                <li class="p-3 bg-white-50 border border-blue-200 rounded">
                    üõ°Ô∏è <strong>Oportunidade de economia em gastos vari√°veis:</strong>
                    <h2>Construa sua reserva de emerg√™ncia (6 meses de gastos).</h2>
                </li>
                <li class="p-3 bg-[#f6f6ff] border border-[#f6f6ff] rounded mt-auto">
                    <div class="flex justify-between items-center p-4 rounded">
                        <div>
                            <h1 class="text-lg font-medium">An√°lises mais detalhadas:</h1>
                            <p class="text-gray-600">Upgrade para Pro e acesse relat√≥rios completos em PDF.</p>
                        </div>
                        <button class="flex gap-4 items-center ml-auto px-4 py-2 bg-[#262d3f] text-white rounded">
                            Upgrade
                        </button>
                    </div>
                </li>
            </ul>
        </div>

        <div class="bg-white p-6 rounded-lg shadow">
            <h2 class="text-xl font-semibold mb-1">Distribui√ß√£o de Gastos</h2>
            <p class="text-gray-500 mb-4">Veja como seus gastos est√£o distribu√≠dos por categoria</p>
            <div class="flex flex-col items-center">
                <canvas id="expensesPieChart" class="h-64 w-64 mx-auto"></canvas>
            </div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow">
            <h2 class="text-xl font-semibold mb-1">Transa√ß√µes Recentes</h2>
            <p class="text-gray-500 text-sm mb-4">Suas √∫ltimas movimenta√ß√µes financeiras</p>
        
            <ul class="divide-y">
                {% for transacao in transacoes_recentes %}
                <li class="flex justify-between py-3">
                    <!-- Lado esquerdo -->
                    <div>
                        <p class="font-semibold">{{ transacao.descricao }}</p>
                        <p class="text-black-500 text-sm">
                            {{ transacao.categoria.nome }} ‚Ä¢ {{ transacao.data|date:"d/m/Y" }}
                        </p>
                    </div>
        
                    <!-- Lado direito -->
                    <div>
                        <span
                            class="{% if transacao.tipo == 'saida' %}text-red-600{% else %}text-green-600{% endif %} font-bold">
                            {% if transacao.tipo == 'saida' %}-{% else %}+{% endif %}
                            R$ {{ transacao.valor|floatformat:2 }}
                        </span>
                    </div>
                </li>
                {% empty %}
                <li class="text-gray-500 py-2">Nenhuma transa√ß√£o registrada ainda.</li>
                {% endfor %}
            </ul>
        </div>

        </div>

        <div class="bg-white p-6 rounded-lg shadow">
            <h2 class="text-lg font-semibold mb-2">Gastos por Categoria</h2>
            <p class="text-sm text-gray-500 mb-2">Distribui√ß√£o dos seus gastos este m√™s</p>
            <select class="border rounded p-2">
                <option>Selecione o m√™s</option>
                <option>Janeiro 2025</option>
                <option>Fevereiro 2025</option>
                <option>Mar√ßo 2025</option>
                <option>Abril 2025</option>
                <option>Maio 2025</option>
                <option>Junho 2025</option>
            </select>
            <div class="space-y-4 mt-5">
                {% for item in gastos_detalhados %}
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <span class="inline-block h-3 w-3 rounded-full"
                            {% if item.cor %}style="background-color: {{ item.cor }};"{% else %}style="background-color: #ccc;"{% endif %}></span>
                        <span>{{ item.nome }}</span>
                    </div>
                    <div class="text-right">
                        <p class="font-semibold">R$ {{ item.valor|floatformat:2|intcomma }}</p>
                        <p class="text-xs text-gray-500">{{ item.porcentagem|floatformat:0 }}%</p>
                    </div>
                </div>
                {% empty %}
                <p class="text-gray-500 text-center">Nenhum gasto encontrado para este per√≠odo.</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

{{ expenses_labels|json_script:"expenses-labels" }}
{{ expenses_data|json_script:"expenses-data" }}
<script>
    // Gr√°fico de Evolu√ß√£o Financeira (Barras)
    const ctx = document.getElementById('financeChart');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago'],
            datasets: [
                {
                    label: 'Receitas',
                    data: receitas.length ? receitas : [],
                    backgroundColor: '#34d399'
                },
                {
                    label: 'Gastos',
                    data: gastos.length ? gastos : [],
                    backgroundColor: '#f87171'
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'bottom' }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });

    // Gr√°fico de Distribui√ß√£o de Gastos (Pizza)
    const expensesLabels = JSON.parse(document.getElementById('expenses-labels').textContent);
    const expensesData = JSON.parse(document.getElementById('expenses-data').textContent);

    if (expensesData && expensesData.length > 0) {
        const ctxPie = document.getElementById('expensesPieChart');
        new Chart(ctxPie, {
            type: 'pie',
            data: {
                labels: expensesLabels,
                datasets: [{
                    label: 'Distribui√ß√£o de Gastos',
                    data: expensesData,
                    backgroundColor: [
                        '#ef4444',
                        '#f97316',
                        '#eab308',
                        '#6366f1',
                        '#22c55e',
                    ],
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' },
                    tooltip: {
                        backgroundColor: 'rgba(255, 255, 255)', // Cor de fundo do bal√£o
                        titleColor: '#000', // Cor do t√≠tulo (ex: "Alimenta√ß√£o")
                        bodyColor: '#000', // Cor do corpo (a porcentagem)
                        borderColor: '#f9fafb', // Cor da borda
                        borderWidth: 1,
                        padding: 10,
                        callbacks: {
                            label: function (tooltipItem) {
                                let label = tooltipItem.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (tooltipItem.raw !== null) {
                                    const total = tooltipItem.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    const percentage = ((tooltipItem.raw / total) * 100).toFixed(0);
                                    label += `${percentage}%`;
                                }
                                return label;
                            }
                        }
                    },
                    legend: {
                        position: 'bottom',
                        align: 'center',
                        labels: {
                            boxWidth: 20,
                            padding: 20,
                            usePointStyle: true
                        }
                    },
                    datalabels: {
                        color: '#000',
                        anchor: 'end',
                        align: 'end',
                        formatter: (value, ctx) => {
                            let label = ctx.chart.data.labels[ctx.dataIndex];
                            let percentage = ((value / ctx.dataset.data.reduce((a, b) => a + b, 0)) * 100).toFixed(0);
                            return `${label} (${percentage}%)`;
                        },
                        font: {
                            weight: 'bold',
                            size: 14
                        }
                    }
                }
            }
        });
    }
</script>
{% endblock %}