{% extends "financas/base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Dashboard - SmartCash{% endblock %}

{% block content %}
{% if messages %}
<div id="messageContainer" class="fixed bottom-4 right-4 z-50">
    {% for message in messages %}
    <div
        class="px-6 py-4 rounded-lg shadow-lg text-white font-semibold transition-all duration-300
                {% if 'error' in message.tags %}bg-red-600{% elif 'success' in message.tags %}bg-green-600{% else %}bg-gray-600{% endif %}">
        <p>{{ message }}</p>
    </div>
    {% endfor %}
</div>
{% endif %}
<div class="p-1">

    <h1 class="text-3xl font-bold mb-2">Ol√°, {{ user.first_name|default:user.username }}! üëã</h1>
    <p class="text-gray-500 mb-6">Aqui est√° um resumo da sua situa√ß√£o financeira atual.</p>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white shadow rounded p-4">
            <h2 class="text-gray-600">Saldo Atual</h2>
            <p class="text-2xl font-bold {% if saldo >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                R$ {{ saldo|floatformat:2|intcomma }}
            </p>
            {% if saldo == 0 %}
            <p class="text-sm text-gray-500">Seu saldo est√° zerado. Adicione uma receita para come√ßar!</p>
            {% elif saldo > 0 %}
            <p class="text-sm text-gray-500">Voc√™ j√° tem R$ {{ saldo|floatformat:2|intcomma }} guardados </p>
            {% else %}
            <p class="text-sm text-gray-500">Seu saldo est√° negativo.</p>
            {% endif %}
        </div>
        <div class="bg-white shadow rounded p-4">
            <h2 class="text-gray-600">Receitas</h2>
            <p class="text-2xl font-bold text-black-600">
                R$ {{ entradas|floatformat:2|intcomma }}
            </p>
            {% if entradas > 0 %}
            <p class="text-sm text-gray-500"> Recebeu um total de R$ {{ entradas|floatformat:2|intcomma }} em receitas.
            </p>
            {% else %}
            <p class="text-sm text-gray-500">Nenhuma receita registrada ainda.</p>
            {% endif %}
        </div>

        <div class="bg-white shadow rounded p-4">
            <h2 class="text-gray-600">Gastos</h2>
            <p class="text-2xl font-bold text-red-600">
                - R$ {{ saidas|floatformat:2|intcomma }}
            </p>
            {% if saidas > 0 %}
            <p class="text-sm text-gray-500"> Gastou R$ {{ saidas|floatformat:2|intcomma }} em suas despesas.</p>
            {% else %}
            <p class="text-sm text-gray-500">Nenhuma despesa registrada ainda.</p>
            {% endif %}
        </div>
        <div class="bg-white shadow rounded p-4">
            <h2 class="text-gray-600">Meta de Economia</h2>
            {% if meta_total > 0 %}
            <p class="text-2xl font-bold text-black-600">
                R$ {{ meta_valor|floatformat:2|intcomma }}
            </p>
            <div class="w-full bg-gray-200 rounded h-3 mt-2">
                <div class="h-3 rounded bg-[#c1b9cc]" style="width: {{ meta_progresso|floatformat:0 }}%;"></div>
            </div>
            <p class="text-sm text-gray-500 mt-1">
                {{ meta_progresso|floatformat:0 }}% da meta de R$ {{ meta_total|floatformat:2|intcomma }}
            </p>
            {% else %}
            <p class="text-2xl font-bold text-gray-600">R$ 0,00</p>
            <p class="text-sm text-gray-600 mt-1">
                Nenhuma meta definida ainda. Crie sua primeira meta.
            </p>
            {% endif %}
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div class="bg-white shadow rounded p-6">
            <h2 class="text-xl font-semibold mb-1">Evolu√ß√£o Financeira</h2>
            <p class="text-gray-500 mb-4">Receitas, gastos e economia nos √∫ltimos 6 meses</p>
            <canvas id="financeChart" class="h-64"></canvas>
        </div>

    <div class="col-span-1 bg-white p-6 rounded-lg shadow flex flex-col justify-between h-full">
        <h2 class="text-xl font-semibold mb-1 flex items-center gap-2">
            <i data-lucide="lightbulb" class="text-yellow-600 w-7 h-7"></i>
            Recomenda√ß√µes Inteligentes
        </h2>
        <p class="text-gray-500 mb-6">An√°lise baseada em IA dos seus h√°bitos financeiros.</p>
        <ul class="space-y-3 flex-1">
            {% for rec in recomendacoes %}
        <li class="p-3 rounded-lg
            {% if rec.tipo == 'atencao' %}bg-white-50 border border-[#e2e8f0] text-black-800{% endif %}
            {% if rec.tipo == 'potencial' %}bg-white-50 border border-[#e2e8f0]text-black-800{% endif %}
            {% if rec.tipo == 'reserva' %}bg-white-50 border border-[#e2e8f0] text-black-800{% endif %}
            {% if rec.tipo == 'oportunidade' %}bg-white-50 border border-[#e2e8f0] text-black-800{% endif %}
        ">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded-full flex items-center justify-center
                    {% if rec.tipo == 'atencao' %}bg-red-100{% endif %}
                    {% if rec.tipo == 'potencial' %}bg-yellow-100{% endif %}
                    {% if rec.tipo == 'reserva' %}bg-yellow-100{% endif %}
                    {% if rec.tipo == 'oportunidade' %}bg-green-100{% endif %}
                ">
                    {% if rec.tipo == 'atencao' %}<i data-lucide="alert-triangle" class="w-5 h-5 text-red-600"></i>{% endif %}
                    {% if rec.tipo == 'potencial' %}<i data-lucide="trending-up" class="w-5 h-5 text-yellow-600"></i>{% endif %}
                    {% if rec.tipo == 'reserva' %}<i data-lucide="target" class="w-5 h-5 text-yellow-600"></i>{% endif %}
                    {% if rec.tipo == 'oportunidade' %}<i data-lucide="lightbulb" class="w-5 h-5 text-green-600"></i>{% endif %}
                </div>
                <h4 class="font-semibold text-sm">{{ rec.titulo }}</h4>
            </div>
            <p class="text-sm mt-2">{{ rec.texto }}</p>
        </li>
        {% empty %}
        <li class="p-3 text-gray-500 text-center">Nenhuma recomenda√ß√£o dispon√≠vel.</li>
        {% endfor %}

        <li class="p-3 bg-[#f6f6ff] border border-[#bfdbfe] rounded mt-auto">
            <div class="flex justify-between items-center p-4 rounded">
                <div>
                    <h1 class="text-lg font-medium">An√°lises mais detalhadas:</h1>
                    <p class="text-gray-600">Upgrade para Pro e acesse relat√≥rios completos em PDF.</p>
                </div>
                <button class="flex gap-4 items-center ml-auto px-4 py-2 bg-[#262d3f] text-white rounded">
                    Upgrade
                </button>
            </div>
        </li>
    </ul>
</div>
        <div class="bg-white p-6 rounded-lg shadow">
            <h2 class="text-xl font-semibold mb-1">Distribui√ß√£o de Gastos</h2>
            <p class="text-gray-500 mb-4">Veja como seus gastos est√£o distribu√≠dos por categoria</p>
            <div class="flex flex-col items-center">
                <canvas id="expensesPieChart" class="h-64 w-64 mx-auto"></canvas>
            </div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow">
            <h2 class="text-xl font-semibold mb-1">Transa√ß√µes Recentes</h2>
            <p class="text-gray-500 text-sm mb-4">Suas √∫ltimas movimenta√ß√µes financeiras</p>

            <ul class="divide-y">
                {% for transacao in transacoes_recentes %}
                <li class="flex justify-between py-3">
                    <!-- Lado esquerdo -->
                    <div>
                        <p class="font-semibold">{{ transacao.descricao }}</p>
                        <p class="text-black-500 text-sm">
                            {{ transacao.categoria.nome }} ‚Ä¢ {{ transacao.data|date:"d/m/Y" }}
                        </p>
                    </div>

                    <!-- Lado direito -->
                    <div>
                        <span
                            class="{% if transacao.tipo == 'saida' %}text-red-600{% else %}text-green-600{% endif %} font-bold">
                            {% if transacao.tipo == 'saida' %}-{% else %}+{% endif %}
                            R$ {{ transacao.valor|floatformat:2 }}
                        </span>
                    </div>
                </li>
                {% empty %}
                <li class="text-gray-500 py-2">Nenhuma transa√ß√£o registrada ainda.</li>
                {% endfor %}
            </ul>
        </div>

    </div>

    <div class="bg-white p-6 rounded-lg shadow">
        <h2 class="text-lg font-semibold mb-2">Gastos por Categoria</h2>
        <p class="text-sm text-gray-500 mb-2">Distribui√ß√£o dos seus gastos este m√™s</p>
        <select class="border rounded p-2">
            <option>Selecione o m√™s</option>
            <option>Janeiro 2025</option>
            <option>Fevereiro 2025</option>
            <option>Mar√ßo 2025</option>
            <option>Abril 2025</option>
            <option>Maio 2025</option>
            <option>Junho 2025</option>
        </select>
        <div class="space-y-4 mt-5">
            {% for item in gastos_detalhados %}
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <span class="inline-block h-3 w-3 rounded-full" style="background-color: {{ item.cor }};">
                    </span>
                    <span>{{ item.nome }}</span>
                </div>
                <div class="text-right">
                    <p class="font-semibold">R$ {{ item.valor|floatformat:2|intcomma }}</p>
                    <p class="text-xs text-gray-500">{{ item.porcentagem|floatformat:0 }}%</p>
                </div>
            </div>
            {% empty %}
            <p class="text-gray-500 text-center">Nenhum gasto encontrado para este per√≠odo.</p>
            {% endfor %}
        </div>
    </div>
</div>
</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
{{ expenses_labels|json_script:"expenses-labels" }}
{{ expenses_data|json_script:"expenses-data" }}

{{ meses_labels|json_script:"meses-labels" }}
{{ receitas_mensais|json_script:"receitas-mensais" }}
{{ gastos_mensais|json_script:"gastos-mensais" }}

<script>
    // Gr√°fico de Evolu√ß√£o Financeira (Barras)
    const mesesLabels = JSON.parse(document.getElementById('meses-labels').textContent);
    const receitasMensais = JSON.parse(document.getElementById('receitas-mensais').textContent);
    const gastosMensais = JSON.parse(document.getElementById('gastos-mensais').textContent);

    if (receitasMensais.length > 0 || gastosMensais.length > 0) {
        const ctx = document.getElementById('financeChart');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: mesesLabels,
                datasets: [
                    {
                        label: 'Receitas',
                        data: receitasMensais,
                        backgroundColor: '#34d399'
                    },
                    {
                        label: 'Gastos',
                        data: gastosMensais,
                        backgroundColor: '#f87171'
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom' }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }

    // Gr√°fico de Distribui√ß√£o de Gastos (Pizza)
    const expensesLabels = JSON.parse(document.getElementById('expenses-labels').textContent);
    const expensesData = JSON.parse(document.getElementById('expenses-data').textContent);

    if (expensesData && expensesData.length > 0) {
        const ctxPie = document.getElementById('expensesPieChart');
        new Chart(ctxPie, {
            type: 'pie',
            data: {
                labels: expensesLabels,
                datasets: [{
                    label: 'Distribui√ß√£o de Gastos',
                    data: expensesData,
                    backgroundColor: [
                        '#ef4444',
                        '#f97316',
                        '#22c55e',
                        '#eab308',
                        '#6366f1',
                    ],
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        align: 'center',
                        labels: {
                            boxWidth: 20,
                            padding: 20,
                            usePointStyle: true
                        }
                    },
                    datalabels: {
                        color: '#000',
                        anchor: 'end',
                        align: 'end',
                        formatter: (value, ctx) => {
                            let label = ctx.chart.data.labels[ctx.dataIndex];
                            let percentage = ((value / ctx.dataset.data.reduce((a, b) => a + b, 0)) * 100).toFixed(0);
                            return `${label} (${percentage}%)`;
                        },
                        font: {
                            weight: 'bold',
                            size: 14
                        }
                    }
                }
            }
        });
    }
    document.addEventListener("DOMContentLoaded", function () {
        const messageContainer = document.getElementById('messageContainer');
        if (messageContainer) {
            setTimeout(function() {
                messageContainer.style.display = 'none';
            }, 5000); // 5000 milissegundos = 5 segundos
        }
    });

</script>
{% endblock %}